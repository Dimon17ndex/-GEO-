<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таймер по QR-коду (старт/стоп)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 40px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }
        #timer {
            font-size: 24px;
            margin: 20px 0;
            color: #333;
        }
        #status {
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #reader {
            width: 300px;
            height: 300px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h1>Таймер по QR‑коду (старт/стоп)</h1>
    <div id="status">Ожидание QR‑кода...</div>
    <div id="timer">00:00:00</div>

    <button id="scanBtn">Сканировать QR‑код</button>

    <div id="reader"></div>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>ID задачи</th>
                <th>Время начала</th>
                <th>Время окончания</th>
                <th>Длительность</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Библиотека для сканирования QR‑кодов -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        let timerInterval = null;
        let startTime = 0;
        let currentTaskId = '';

        const timerDisplay = document.getElementById('timer');
        const statusDisplay = document.getElementById('status');
        const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];

        // Инициализируем сканер
        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });

        // Запуск таймера (начало работы)
        function startTimer(taskId) {
            currentTaskId = taskId;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);

                timerDisplay.textContent =
                    [hours, minutes, seconds]
                        .map(val => val.toString().padStart(2, '0'))
                        .join(':');
            }, 1000);
            statusDisplay.textContent = `Работа начата! ID задачи: ${taskId}`;
        }

        // Остановка таймера (завершение работы)
        function stopTimer(stopTaskId) {
            if (timerInterval && currentTaskId === stopTaskId) {
                clearInterval(timerInterval);
                timerInterval = null;

                const endTime = Date.now();
                const duration = formatTime(endTime - startTime);
                const startTimeFormatted = new Date(startTime).toLocaleString();
                const endTimeFormatted = new Date(endTime).toLocaleString();


                // Добавляем строку в таблицу
                const row = resultsTable.insertRow();
                row.insertCell(0).textContent = stopTaskId;
                row.insertCell(1).textContent = startTimeFormatted;
                row.insertCell(2).textContent = endTimeFormatted;
                row.insertCell(3).textContent = duration;


                statusDisplay.textContent = `Работа завершена! ID задачи: ${stopTaskId}`;
                currentTaskId = ''; // Очищаем текущий ID
            } else {
                statusDisplay.textContent = 'Ошибка: ID задачи не совпадает или таймер не запущен.';
            }
        }

        // Форматирование длительности
        function formatTime(milliseconds) {
            const seconds = Math.floor((milliseconds / 1000) % 60);
            const minutes = Math.floor((milliseconds / (1000 * 60)) % 60);
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            return `${hours}:${minutes}:${seconds}`;
        }

        // Обработчик успешного сканирования
        function onScanSuccess(decodedText) {
            const [action, taskId] = decodedText.split('_');

            if (action === 'START' && !currentTaskId) {
                startTimer(taskId);
            } else if (action === 'STOP' && currentTaskId === taskId) {
                stopTimer(taskId);
            } else {
                statusDisplay.textContent = 'Ошибка: неверный QR‑код или несоответствие ID.';
            }
        }

        // Обработчик ошибок
        function onScanFailure(error) {
            console.warn("Ошибка сканирования:", error);
            statusDisplay.textContent = 'Ошибка сканирования. Попробуйте ещё раз.';
        }

        // Привязка к кнопке
        document.getElementById('scanBtn').addEventListener('click', () => {
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            statusDisplay.textContent = "Ожидание QR‑кода...";
        });
    </script>
</body>
</html>
